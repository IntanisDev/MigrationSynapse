{
	"name": "STD_VTA_SAP_DELTA_V2",
	"properties": {
		"description": "Venta SAP a Capa Estandar",
		"folder": {
			"name": "Retail/Venta Diaria"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "VENTASAP_RAW",
						"type": "DatasetReference"
					},
					"name": "vtaRAW"
				},
				{
					"dataset": {
						"referenceName": "DL_PQT_MARA2",
						"type": "DatasetReference"
					},
					"name": "MARA2"
				},
				{
					"dataset": {
						"referenceName": "DL_HOMOLOGA_EAN11",
						"type": "DatasetReference"
					},
					"name": "EAN11"
				},
				{
					"dataset": {
						"referenceName": "VW_TIPO_CAMBIO",
						"type": "DatasetReference"
					},
					"name": "tipoCambio"
				},
				{
					"dataset": {
						"referenceName": "VENTASAP_RAW_SINGLE",
						"type": "DatasetReference"
					},
					"name": "vtaRAWsINGLE"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "VENTASAP_DIARIA_STD",
						"type": "DatasetReference"
					},
					"name": "vtaSTD"
				}
			],
			"transformations": [
				{
					"name": "CalculaColumnas"
				},
				{
					"name": "joinMARA2"
				},
				{
					"name": "joinEAN11"
				},
				{
					"name": "FiltraColumnas"
				},
				{
					"name": "tipoCAM"
				},
				{
					"name": "PRODPOS"
				},
				{
					"name": "union1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          CODPAISVTA as string,",
				"          CODEMPRVTA as string,",
				"          CODWERKS as string,",
				"          CODWERKSRET as string,",
				"          NUMVTA as string,",
				"          FECHVTA as string,",
				"          FECHENTR as string,",
				"          CLI_RUT as string,",
				"          CLI_TIPIDENT as string,",
				"          CLI_NOMBRE as string,",
				"          CLI_APELLIDOS as string,",
				"          CLI_TELEFONO as string,",
				"          CLI_GIRO as string,",
				"          CLI_DIREC as string,",
				"          CLI_NUM as string,",
				"          CLI_COMUNA as string,",
				"          CLI_CIUDAD as string,",
				"          CLI_REGION as string,",
				"          CLI_PAIS as string,",
				"          TIPDOCEMIT as string,",
				"          I_CAB_REFERENCIA as string,",
				"          FECHREF as string,",
				"          DESCTREC as string,",
				"          RETTDA as string,",
				"          TIPDOCREF as string,",
				"          CODPOS as string,",
				"          POS as string,",
				"          TOTMEDPAG as float,",
				"          CODAUT as string,",
				"          CODTARJ as string,",
				"          NOMTARJ as string,",
				"          NROCUOTA as string,",
				"          BANCO as string,",
				"          TIPCAMB as float,",
				"          CODMON as string,",
				"          PRODPOS as string,",
				"          CODPROD as string,",
				"          CANT as float,",
				"          MONTO as float,",
				"          MTODESC as float,",
				"          PRODFECHREF as string,",
				"          SIGNO as string,",
				"          REFERENCIA as string,",
				"          VENDEDOR as string,",
				"          CAJA as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: true,",
				"     enableCdc: true,",
				"     mode: 'read',",
				"     skipInitialLoad: false,",
				"     format: 'parquet',",
				"     partitionBy('dynamicRange', 5,",
				"          CODWERKS",
				"     )) ~> vtaRAW",
				"source(output(",
				"          MATNR as string,",
				"          FECHA_CREACION as string,",
				"          NUMERO_GTIN as string,",
				"          GRUPO_ARTICULO as string,",
				"          GENERICO as string,",
				"          {AÑO_ESTACION} as string,",
				"          TALLA as string,",
				"          MODELO as string,",
				"          BLOQUEO as string,",
				"          COD_TEMPORADA_PERU as string,",
				"          DENOMINACION_TEMPORADA_PERU as string,",
				"          {COD_AÑO_ESTACION_PERU} as string,",
				"          {DENOMINACION_AÑO_ESTACION_PERU} as string,",
				"          COD_GRADO_MODA_PERU as string,",
				"          DENOMINACION_GRADO_MODA_PERU as string,",
				"          COD_GRADO_MODA as string,",
				"          COD_TEMPORADA as string,",
				"          COD_ROYALTI as string,",
				"          DENOMINACION_GRADO_MODA as string,",
				"          DENOMINACION_TEMPORADA as string,",
				"          DENOMINACION_ROYALTI as string,",
				"          COD_COLOR as string,",
				"          DENOMINACION_COLOR as string,",
				"          COD_MARCA as string,",
				"          DENOMINACION_MARCA as string,",
				"          COD_GENERO as string,",
				"          DENOMINACION_GENERO as string,",
				"          COD_LINEA as string,",
				"          DENOMINACION_LINEA as string,",
				"          COD_TIPO as string,",
				"          DENOMINACION_TIPO as string,",
				"          COD_PRENDA as string,",
				"          DENOMINACION_PRENDA as string,",
				"          COD_LARGO as string,",
				"          DENOMINACION_LARGO as string,",
				"          COD_GENERICO as string,",
				"          COD_CALIDAD as string,",
				"          DENOMINACION_CALIDAD as string,",
				"          PC9 as string,",
				"          PC13 as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> MARA2",
				"source(output(",
				"          MATNR as string,",
				"          EAN11 as string,",
				"          MTART as string,",
				"          MAKTG as string,",
				"          BRAND_ID as string,",
				"          brand_id_desc as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> EAN11",
				"source(output(",
				"          moneda_de as string,",
				"          moneda_a as string,",
				"          Tasa_cambio as decimal(8,5),",
				"          anio as string,",
				"          descripcion as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     isolationLevel: 'READ_UNCOMMITTED',",
				"     format: 'table') ~> tipoCambio",
				"source(output(",
				"          CODPAISVTA as string,",
				"          CODEMPRVTA as string,",
				"          CODWERKS as string,",
				"          CODWERKSRET as string,",
				"          NUMVTA as string,",
				"          FECHVTA as string,",
				"          FECHENTR as string,",
				"          CLI_RUT as string,",
				"          CLI_TIPIDENT as string,",
				"          CLI_NOMBRE as string,",
				"          CLI_APELLIDOS as string,",
				"          CLI_TELEFONO as string,",
				"          CLI_GIRO as string,",
				"          CLI_DIREC as string,",
				"          CLI_NUM as string,",
				"          CLI_COMUNA as string,",
				"          CLI_CIUDAD as string,",
				"          CLI_REGION as string,",
				"          CLI_PAIS as string,",
				"          TIPDOCEMIT as string,",
				"          I_CAB_REFERENCIA as string,",
				"          FECHREF as string,",
				"          DESCTREC as string,",
				"          RETTDA as string,",
				"          TIPDOCREF as string,",
				"          CODPOS as string,",
				"          POS as string,",
				"          TOTMEDPAG as float,",
				"          CODAUT as string,",
				"          CODTARJ as string,",
				"          NOMTARJ as string,",
				"          NROCUOTA as string,",
				"          BANCO as string,",
				"          TIPCAMB as float,",
				"          CODMON as string,",
				"          PRODPOS as string,",
				"          CODPROD as string,",
				"          CANT as float,",
				"          MONTO as float,",
				"          MTODESC as float,",
				"          PRODFECHREF as string,",
				"          SIGNO as string,",
				"          REFERENCIA as string,",
				"          VENDEDOR as string,",
				"          CAJA as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     enableCdc: true,",
				"     mode: 'read',",
				"     skipInitialLoad: false,",
				"     format: 'parquet',",
				"     partitionBy('dynamicRange', 5,",
				"          CODWERKS",
				"     )) ~> vtaRAWsINGLE",
				"union1 derive(FECHVTA = toDate(FECHVTA,'yyyyMMdd'),",
				"          PRODFECHREF = toDate(PRODFECHREF,'yyyyMMdd'),",
				"          FECHENTR = toDate(FECHENTR,'yyyyMMdd'),",
				"          FECHREF = toDate(FECHREF,'yyyyMMdd'),",
				"          rut_vendedor_sin_DV = replace(VENDEDOR,'-',''),",
				"          CODMON = iif(isNull(CODMON), iif(CODPAISVTA=='CL', 'CLP', iif(CODPAISVTA=='PE', 'PEN', iif(CODPAISVTA=='BO', 'BOB', 'USD'))), CODMON),",
				"          ANO_VENTA = toString(year(toDate(PRODFECHREF,'yyyyMMdd'))),",
				"          MONTO = iif(SIGNO=='-',(MONTO*-1)/1.19,MONTO/1.19),",
				"          CANT = iif(SIGNO=='-',CANT*-1,CANT),",
				"          MTODESC = iif(SIGNO=='-',MTODESC*-1,MTODESC)) ~> CalculaColumnas",
				"joinEAN11, MARA2 join(EAN11@MATNR == MARA2@MATNR,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     partitionBy('dynamicRange', 10,",
				"          CODWERKS",
				"     ),",
				"     broadcast: 'auto')~> joinMARA2",
				"CalculaColumnas, EAN11 join(CODPROD == EAN11,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> joinEAN11",
				"tipoCAM select(mapColumn(",
				"          CODPAISVTA,",
				"          CODEMPRVTA,",
				"          CODWERKS,",
				"          CODWERKSRET,",
				"          NUMVTA,",
				"          FECHVTA,",
				"          FECHENTR,",
				"          CLI_RUT,",
				"          CLI_TIPIDENT,",
				"          CLI_NOMBRE,",
				"          CLI_APELLIDOS,",
				"          CLI_TELEFONO,",
				"          CLI_GIRO,",
				"          CLI_DIREC,",
				"          CLI_NUM,",
				"          CLI_COMUNA,",
				"          CLI_CIUDAD,",
				"          CLI_REGION,",
				"          CLI_PAIS,",
				"          TIPDOCEMIT,",
				"          I_CAB_REFERENCIA,",
				"          FECHREF,",
				"          DESCTREC,",
				"          RETTDA,",
				"          TIPDOCREF,",
				"          CODPOS,",
				"          POS,",
				"          TOTMEDPAG,",
				"          CODAUT,",
				"          CODTARJ,",
				"          NOMTARJ,",
				"          NROCUOTA,",
				"          BANCO,",
				"          TIPCAMB = Tasa_cambio,",
				"          CODMON,",
				"          PRODPOS,",
				"          CODPROD,",
				"          CANT,",
				"          MONTO,",
				"          MTODESC,",
				"          PRODFECHREF,",
				"          SIGNO,",
				"          REFERENCIA,",
				"          VENDEDOR,",
				"          CAJA,",
				"          MATNR = EAN11@MATNR,",
				"          EAN11,",
				"          MTART,",
				"          MAKTG,",
				"          FECHA_CREACION,",
				"          GRUPO_ARTICULO,",
				"          GENERICO,",
				"          {AÑO_ESTACION},",
				"          TALLA,",
				"          MODELO,",
				"          BLOQUEO,",
				"          COD_TEMPORADA_PERU,",
				"          DENOMINACION_TEMPORADA_PERU,",
				"          {COD_AÑO_ESTACION_PERU},",
				"          {DENOMINACION_AÑO_ESTACION_PERU},",
				"          COD_GRADO_MODA_PERU,",
				"          DENOMINACION_GRADO_MODA_PERU,",
				"          COD_GRADO_MODA,",
				"          COD_TEMPORADA,",
				"          COD_ROYALTI,",
				"          DENOMINACION_GRADO_MODA,",
				"          DENOMINACION_TEMPORADA,",
				"          DENOMINACION_ROYALTI,",
				"          COD_COLOR,",
				"          DENOMINACION_COLOR,",
				"          COD_MARCA = BRAND_ID,",
				"          DENOMINACION_MARCA = brand_id_desc,",
				"          COD_GENERO,",
				"          DENOMINACION_GENERO,",
				"          COD_LINEA,",
				"          DENOMINACION_LINEA,",
				"          COD_TIPO,",
				"          DENOMINACION_TIPO,",
				"          COD_PRENDA,",
				"          DENOMINACION_PRENDA,",
				"          COD_LARGO,",
				"          DENOMINACION_LARGO,",
				"          COD_GENERICO,",
				"          COD_CALIDAD,",
				"          DENOMINACION_CALIDAD,",
				"          PC9,",
				"          PC13",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> FiltraColumnas",
				"joinMARA2, tipoCambio join(CODMON == moneda_de",
				"     && ANO_VENTA == anio,",
				"     joinType:'left',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> tipoCAM",
				"vtaRAWsINGLE filter(!isNull(PRODPOS)) ~> PRODPOS",
				"vtaRAW, PRODPOS union(byName: true)~> union1",
				"FiltraColumnas sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     format: 'parquet',",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     mapColumn(",
				"          CODPAISVTA,",
				"          CODEMPRVTA,",
				"          CODWERKS,",
				"          CODWERKSRET,",
				"          NUMVTA,",
				"          FECHVTA,",
				"          FECHENTR,",
				"          CLI_RUT,",
				"          CLI_TIPIDENT,",
				"          CLI_NOMBRE,",
				"          CLI_APELLIDOS,",
				"          CLI_TELEFONO,",
				"          CLI_GIRO,",
				"          CLI_DIREC,",
				"          CLI_NUM,",
				"          CLI_COMUNA,",
				"          CLI_CIUDAD,",
				"          CLI_REGION,",
				"          CLI_PAIS,",
				"          TIPDOCEMIT,",
				"          I_CAB_REFERENCIA,",
				"          FECHREF,",
				"          DESCTREC,",
				"          RETTDA,",
				"          TIPDOCREF,",
				"          CODPOS,",
				"          POS,",
				"          TOTMEDPAG,",
				"          CODAUT,",
				"          CODTARJ,",
				"          NOMTARJ,",
				"          NROCUOTA,",
				"          BANCO,",
				"          TIPCAMB,",
				"          CODMON,",
				"          PRODPOS,",
				"          CODPROD,",
				"          CANT,",
				"          MONTO,",
				"          MTODESC,",
				"          PRODFECHREF,",
				"          SIGNO,",
				"          REFERENCIA,",
				"          VENDEDOR,",
				"          CAJA,",
				"          MATNR,",
				"          EAN11,",
				"          MTART,",
				"          MAKTG,",
				"          FECHA_CREACION,",
				"          GRUPO_ARTICULO,",
				"          GENERICO,",
				"          {AÑO_ESTACION},",
				"          TALLA,",
				"          MODELO,",
				"          BLOQUEO,",
				"          COD_TEMPORADA_PERU,",
				"          DENOMINACION_TEMPORADA_PERU,",
				"          {COD_AÑO_ESTACION_PERU},",
				"          {DENOMINACION_AÑO_ESTACION_PERU},",
				"          COD_GRADO_MODA_PERU,",
				"          DENOMINACION_GRADO_MODA_PERU,",
				"          COD_GRADO_MODA,",
				"          COD_TEMPORADA,",
				"          COD_ROYALTI,",
				"          DENOMINACION_GRADO_MODA,",
				"          DENOMINACION_TEMPORADA,",
				"          DENOMINACION_ROYALTI,",
				"          COD_COLOR,",
				"          DENOMINACION_COLOR,",
				"          COD_MARCA,",
				"          DENOMINACION_MARCA,",
				"          COD_GENERO,",
				"          DENOMINACION_GENERO,",
				"          COD_LINEA,",
				"          DENOMINACION_LINEA,",
				"          COD_TIPO,",
				"          DENOMINACION_TIPO,",
				"          COD_PRENDA,",
				"          DENOMINACION_PRENDA,",
				"          COD_LARGO,",
				"          DENOMINACION_LARGO,",
				"          COD_GENERICO,",
				"          COD_CALIDAD,",
				"          DENOMINACION_CALIDAD,",
				"          PC9,",
				"          PC13",
				"     ),",
				"     partitionBy('dynamicRange', 10,",
				"          CODWERKS",
				"     )) ~> vtaSTD"
			]
		}
	}
}